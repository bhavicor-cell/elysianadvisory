<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Elysian Advisory</title>

<link rel="preload" as="video" href="video.webm" type="video/webm">

<style>
  /* Firefox */
html { scrollbar-width: thin; scrollbar-color: rgba(17,17,17,.25) transparent; }
/* WebKit */
::-webkit-scrollbar{ width:10px; }
::-webkit-scrollbar-track{ background:transparent; }
::-webkit-scrollbar-thumb{
  background: rgba(17,17,17,.22);
  border:2px solid transparent; border-radius:8px; background-clip: padding-box;
}
::-webkit-scrollbar-thumb:hover{ background: rgba(17,17,17,.35); }

  :root{
    --vh:100svh;
    --page-bg:#fffff;
    --ink:#13294B;
    --video-opacity:0.03;
    --video-speed:0.05;
    --tint-opacity:0.00;
  }
  :root.final-reveal{
    --page-bg:#FFFFFF;
    --video-opacity:0.001;
  }

  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;overflow:hidden}
  html{background-color:#000;color:var(--ink);}
  body{font:400 16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink)}

  @font-face{font-family:'Anecor';src:url('./Fonts/anecor-gheroos.otf') format('opentype');font-display:swap}

  /* Boot cover */
  #boot-cover{
    position:fixed; inset:0; background:#000; z-index:100000;
    opacity:1; transition:opacity .45s ease;
    pointer-events:none; user-select:none;
  }
  #boot-cover.is-gone{ opacity:0; }
  #boot-cover[aria-hidden="true"]{ display:none; }

  /* Global BG */
  #site-bg{
    position:fixed; inset:0; z-index:0;
    background-color:var(--page-bg);
    pointer-events:none; overflow:hidden;
    transition: background-color .6s ease;
  }
  #bg-video{
    position:absolute; top:50%; left:50%;
    min-width:100%; min-height:100%;
    transform:translate(-50%,-50%);
    object-fit:cover; opacity:var(--video-opacity);
    transition:opacity .6s ease;
  }
  #bg-tint{position:absolute; inset:0; mix-blend-mode:soft-light; background:var(--ink); opacity:var(--tint-opacity)}
  @media (prefers-reduced-motion:reduce){
    #bg-video{display:none}
    #bg-tint{mix-blend-mode:normal;opacity:.06}
  }

  /* Scroll stack */
  #stackScroll{
    position:fixed; inset:0; width:100vw; height:var(--vh);
    overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch;
    /* We fully control paging, so disable native snap & native smoothing */
    scroll-snap-type:none;
    scroll-behavior:auto;
    overscroll-behavior-y:contain;
    touch-action:pan-y;
    background:transparent; z-index:1;
  }
  .stack-section{
    position:relative; width:100vw; height:var(--vh);
    overflow:hidden;
  }

  .stack-frame{
    position:absolute; top:-1px; left:-1px;
    width:calc(100vw + 2px); height:calc(var(--vh) + 2px);
    display:block; border:0; background:transparent;
  }

  /* Hide the only real scroller’s scrollbar (keep our letter rail only) */
  #stackScroll{
    scrollbar-width: none !important;
    -ms-overflow-style: none !important;
  }
  #stackScroll::-webkit-scrollbar{
    width: 0 !important;
    height: 0 !important;
    display: none !important;
  }

  /* Glass nav */
  .subtle-nav{
    position:fixed; top:20px; right:24px; display:flex; gap:6px; padding:8px 10px;
    border-radius:999px; background:rgba(255,255,255,.55); border:1px solid rgba(0,0,0,.07);
    box-shadow:0 8px 24px rgba(0,0,0,.06); color:var(--ink);
    opacity:0; transform:translateY(-6px); z-index:9999; pointer-events:none;
    transition:opacity .25s ease, transform .25s ease;
  }
  .subtle-nav.is-visible{opacity:.95; transform:translateY(0); pointer-events:auto}
  .subtle-nav:hover{opacity:1; box-shadow:0 10px 28px rgba(0,0,0,.06)}
  .nav-btn{
    background:transparent; border:0; border-radius:999px; padding:6px 10px; cursor:pointer;
    font:600 12px/1.1 'Anecor',system-ui,-apple-system,Segoe UI,sans-serif;
    letter-spacing:.12em; text-transform:uppercase;
    transition:opacity .2s ease, background-color .2s ease, transform .12s ease; color:var(--ink);
  }

  /* put these OUTSIDE the block above */
.subtle-nav a.nav-btn,
.subtle-nav a.nav-btn:hover,
.subtle-nav a.nav-btn:visited{
  text-decoration: none;
  color: var(--ink);
}

  /* optional: make <a> look/align like the button version */
a.nav-btn{ display:inline-flex; align-items:center; }
  
  .nav-btn:hover{background:rgba(0,0,0,.04)}
  .nav-btn:active{transform:translateY(1px)}

  /* Dock logo */
  :root{
    --dock-logo-w:clamp(90px,8vw,170px);
    --dock-logo-top:calc(18px + env(safe-area-inset-top));
    --dock-logo-left:18px;
    --dock-shadow-soft:0 10px 18px rgba(0,0,0,.06);
  }
  #ElysianDockLogo{
    position:fixed; z-index:10000; pointer-events:auto;
    top:var(--dock-logo-top); left:var(--dock-logo-left);
    width:var(--dock-logo-w); height:auto; cursor: pointer;
    opacity:0; transform:none; filter:drop-shadow(var(--dock-shadow-soft));
    transition:opacity .5s cubic-bezier(.25,1,.5,1);
    will-change:opacity; contain:layout paint;
  }
  #ElysianDockLogo>img,#ElysianDockLogo>svg{display:block;width:100%;height:auto}
  body.logo-visible #ElysianDockLogo{opacity:1}
  @media (prefers-reduced-motion:reduce){#ElysianDockLogo{transition:none}}

  /* ===================== ELYSIAN RAIL ===================== */
  #elysian-rail{
    position: fixed;
    right: calc(env(safe-area-inset-right, 0px) - 2px); /* hug the edge */
    top: 50%;
    /* tuck uses --x; 0 = visible, positive = pushed off the screen a bit */
    --x: -8px;
    transform: translate(var(--x), -50%);
    display: grid;
    gap: 6px;
    z-index: 10020;
    pointer-events: none;
    opacity: 0;
    transition:
      opacity 180ms ease,
      transform 240ms cubic-bezier(.22,.61,.36,1);
  }
  #elysian-rail.is-visible{
    opacity: .35;               /* lighter at idle */
    pointer-events: auto;
  }
  #elysian-rail.is-visible.is-tucked{ opacity: .40; }  /* extra subtle while tucked */
  #elysian-rail:hover,
  #elysian-rail:focus-within{ opacity: .98; }          /* full when interacted */

  /* faint edge track */
  #elysian-rail::before{
    content:"";
    position:absolute;
    right: -6px;
    top: -8px; bottom: -8px;
    width: 2px;
    background: linear-gradient(transparent, rgba(0,0,0,.22), transparent);
    opacity:.35;
    pointer-events:none;
  }

  /* sliding dot indicator */
  #elysian-rail{ --indY: 0px; }
  #elysian-rail::after{
    content:none;
    position:absolute;
    right: -9px;
    top: calc(var(--indY));
    transform: translateY(-50%);
    width: 6px; height: 6px; border-radius: 50%;
    background: #13294b;
    box-shadow:
      0 0 0 3px rgba(19,41,75,.18),
      0 0 14px rgba(19,41,75,.45);
    transition: top 220ms cubic-bezier(.22,.61,.36,1);
    pointer-events:none;
  }

  #elysian-rail .letter{
    all: unset;
    cursor: pointer;
    display: grid;
    place-items: center;
    width: 26px; height: 26px;        /* compact */
    border-radius: 999px;
    font-family: 'Anecor', system-ui;
    font-weight: 700;
    font-size: 11px;
    letter-spacing: .08em;
    color: #1a1a1a;
    background: rgba(255,255,255,.68);
    border: 1px solid rgba(0,0,0,.10);
    box-shadow: 0 8px 18px rgba(0,0,0,.08);
    will-change: transform;
    transition: transform 160ms ease, background .2s, color .2s, box-shadow .2s, border-color .2s;
  }
  #elysian-rail .letter:hover{ transform: translateY(-1px); }
  #elysian-rail .letter[aria-selected="true"]{
    background: #13294b;   /* BLUE when active */
    color: #fff;
    border-color: rgba(0,0,0,.18);
    box-shadow: 0 12px 28px rgba(0,0,0,.18), 
                0 0 0 2px rgba(19,41,75,.12) inset;
    transform: translateY(-1px) scale(1.04);
  }

  @media (max-width: 820px){
    #elysian-rail{
      right: calc(env(safe-area-inset-right, 0px) - 1px);
      gap: 4px;
    }
    #elysian-rail .letter{ width: 24px; height: 24px; font-size: 10px; }
    #elysian-rail::after{ right: -8px; }
    #elysian-rail::before{ right: -5px; }
  }
  /* Tuck pose = push slightly off the edge to the RIGHT (less distracting) */
  #elysian-rail.is-tucked{ --x: 0.9px; }   /* adjust this number to tuck more/less */
  /* =================== END ELYSIAN RAIL =================== */
</style>
</head>
<body>

  <div id="boot-cover" aria-hidden="false"></div>

  <div id="site-bg" aria-hidden="true">
    <video id="bg-video" muted playsinline autoplay loop preload="metadata" poster="video-poster.jpg">
      <source src="video.webm" type="video/webm">
      <source src="3.mp4" type="video/mp4">
    </video>
    <div id="bg-tint"></div>
  </div>

  <div id="ElysianDockLogo" aria-hidden="true" role="button" tabindex="0" aria-label="Go to top">
    <img src="./assets/LF.svg" alt="Elysian Advisory" decoding="async" fetchpriority="low" width="200" height="60" />
  </div>

  <nav class="subtle-nav" id="globalHeroNav" aria-label="Primary">
    <a class="nav-btn" href="/writings/">Writings</a>
    <a class="nav-btn" href="/instruments/">Instruments</a>
    <button class="nav-btn" type="button" data-target="connect">Connect</button>
  </nav>

  <!-- ================= ELYSIAN RAIL ================= -->
  <div id="elysian-rail" role="tablist" aria-label="Elysian section nav">
    <button class="letter" data-target="hero"        aria-selected="false">E</button>
    <button class="letter" data-target="for"         aria-selected="false">L</button>
    <button class="letter" data-target="action"      aria-selected="false">Y</button>
    <button class="letter" data-target="truth"       aria-selected="false">S</button>
    <button class="letter" data-target="work"        aria-selected="false">I</button>
    <button class="letter" data-target="trust"       aria-selected="false">A</button>
    <button class="letter" data-target="@s7"         aria-selected="false">N</button>
  </div>
  <!-- =============== END ELYSIAN RAIL =============== -->

  <main id="stackScroll" aria-label="Stacked sections"></main>

  <script>
    /* === Input Freeze Guard (prevents overscrolling past S6) === */
window.__elysianFreezeUntil = 0;
function __elysianFreezeInput(ms = 1000){
  const now = (performance && performance.now) ? performance.now() : Date.now();
  window.__elysianFreezeUntil = now + ms;
}

/* === Hard Brake: block parent scroll + iframe pointers briefly === */
function __elysianHardBrake(ms = 1400){
  try{
    const root = document.getElementById('stackScroll');
    const trustFrame = document.getElementById('frame-trust');
    if (!root) return;

    const prevOverflow = root.style.overflowY;

    root.style.overflowY = 'hidden';
    if (trustFrame) trustFrame.style.pointerEvents = 'none';

    __elysianFreezeInput(ms);
    window.__elysianAbortWheel?.();
    window.__elysianCancelSettle?.();

    setTimeout(()=>{
      root.style.overflowY = prevOverflow || 'auto';
      if (trustFrame) trustFrame.style.pointerEvents = '';
    }, ms);
  }catch(_){}
}

    /* Per-section bg controls */
    const BG_CONFIG = {
      hero:{opacity:0.047,speed:0.3},
      for:{opacity:0.033,speed:0.28},
      action:{opacity:0.033,speed:0.28},
      truth:{opacity:0.033,speed:0.28},
      work:{opacity:0.033,speed:0.28},
      trust:{opacity:0.033,speed:0.28},
      'trust-2':{opacity:0.0012,speed:0.25}
    };

    const SECTION_MANIFEST = [
      {id:'hero',title:'Hero',src:'./sections/01.html'},
      {id:'for',title:'Clarity For',src:'./sections/02.html'},
      {id:'action',title:'Clarity In Action',src:'./sections/03.html'},
      {id:'truth',title:'Truth',src:'./sections/04.html'},
      {id:'work',title:'Work With Us',src:'./sections/05.html'},
      {id:'trust',title:'Trust Us',src:'./sections/06.html'}
    ];

    /* === map ids <-> indexes (used by message bridge) === */
    const ID_TO_INDEX = Object.fromEntries(SECTION_MANIFEST.map((it,i)=>[it.id,i]));
    const INDEX_TO_ID = SECTION_MANIFEST.map(it=>it.id);

    /* Viewport height prop */
    function setVH(){
      const h = Math.max(1, Math.round(window.innerHeight || document.documentElement.clientHeight || 0));
      document.documentElement.style.setProperty('--vh', h + 'px');
    }
    setVH();
    window.addEventListener('resize', setVH, {passive:true});
    window.addEventListener('orientationchange', setVH);

    const stackEl = document.getElementById('stackScroll');
    const bootCover = document.getElementById('boot-cover');

    /* Keep hero opaque; others transparent */
    function injectNoScrollCSS(doc, makeTransparent = true){
      try{
        const style = doc.createElement('style');
        style.textContent =
'html,body{height:100%;overflow:hidden!important;margin:0!important;padding:0!important;' + (makeTransparent ? 'background:transparent!important;' : '') + '}' +
'*{box-sizing:border-box;}::-webkit-scrollbar{display:none;}';
        doc.head.appendChild(style);
      }catch(e){}
    }

    function applyBG(sectionEl){
      const rootEl = document.documentElement;
      const bgVideo = document.getElementById('bg-video');
      const DEFAULT_VIDEO_OPACITY = parseFloat(getComputedStyle(rootEl).getPropertyValue('--video-opacity')) || 0.22;
      const DEFAULT_BG_SPEED = 0.8;

      const o = parseFloat(sectionEl && sectionEl.dataset ? sectionEl.dataset.bgOpacity : '');
      const s = parseFloat(sectionEl && sectionEl.dataset ? sectionEl.dataset.bgSpeed : '');
      const videoOpacity = Number.isFinite(o) ? o : DEFAULT_VIDEO_OPACITY;
      const speed = Number.isFinite(s) ? s : DEFAULT_BG_SPEED;

      rootEl.style.setProperty('--video-opacity', String(videoOpacity));
      try{ if(bgVideo) bgVideo.playbackRate = speed; }catch(e){}
    }

    function makeStack(){
      stackEl.innerHTML = '';
      SECTION_MANIFEST.forEach(function(item, idx){
        const wrapper = document.createElement('section');
        wrapper.className = 'stack-section';
        wrapper.id = 'sec-' + item.id;
        wrapper.setAttribute('aria-label', item.title ? item.title : ('Section ' + (idx+1)));

        const conf = BG_CONFIG[item.id] || {};
        if (conf.opacity != null) wrapper.dataset.bgOpacity = String(conf.opacity);
        if (conf.speed != null) wrapper.dataset.bgSpeed = String(conf.speed);

        const frame = document.createElement('iframe');
        frame.className = 'stack-frame';
        frame.id = 'frame-' + item.id;
        frame.title = item.title || item.src;
        frame.dataset.src = item.src;
        frame.referrerPolicy = 'no-referrer';
        frame.setAttribute('allowtransparency','true');
        frame.setAttribute('scrolling','no');

        if (idx === 0){
          frame.src = frame.dataset.src; // load hero immediately
        } else {
          frame.loading = 'lazy';
        }

        frame.addEventListener('load', function(){
          try{
            const doc = frame.contentDocument;
            if (doc) injectNoScrollCSS(doc, idx !== 0); // HERO stays opaque
          }catch(e){}

          if (idx === 0){
            const heroSection = document.getElementById('sec-hero');
            if (heroSection) applyBG(heroSection);
            requestAnimationFrame(()=>{
              bootCover.classList.add('is-gone');
              setTimeout(()=>bootCover.setAttribute('aria-hidden','true'), 500);
            });
          }
        });

        frame.addEventListener('error', function(e){
          console.error('Iframe failed to load:', item.src, e);
          if (idx === 0){
            requestAnimationFrame(()=>{
              bootCover.classList.add('is-gone');
              setTimeout(()=>bootCover.setAttribute('aria-hidden','true'), 500);
            });
          }
        });

        wrapper.appendChild(frame);
        stackEl.appendChild(wrapper);
      });
    }
    makeStack();

    // Lazy-activate non-hero frames
    (function(){
      const root = stackEl;
      if (!root) return;
      const framesState = new Map();
      const framesObserver = new IntersectionObserver(function(entries){
        entries.forEach(function(entry){
          const frame = entry.target;
          if (frame.id === 'frame-hero') return;
          const id = frame.id || frame.title || frame.dataset.src;
          if (!framesState.has(id)) framesState.set(id, {live:false});

          if (entry.isIntersecting && !framesState.get(id).live){
            frame.src = frame.dataset.src;
            framesState.get(id).live = true;
          } else if (!entry.isIntersecting){
            const rect = frame.getBoundingClientRect();
            const vh = window.innerHeight || document.documentElement.clientHeight;
            if (rect.top > vh*2 || rect.bottom < -vh*2){
              if (framesState.get(id).live){
                frame.src = 'about:blank';
                framesState.get(id).live = false;
              }
            }
          }
        });
      }, {root: root, rootMargin:'120% 0px', threshold:0.01});

      document.querySelectorAll('.stack-frame').forEach(function(f){ framesObserver.observe(f); });
    })();

    /* Nav + logo + rail visibility + rail active letter */
    const globalNav = document.getElementById('globalHeroNav');
    const railEl = document.getElementById('elysian-rail');

    function getVH(){ return Math.max(1, Math.round(window.innerHeight || document.documentElement.clientHeight || 0)); }
    function sectionCount(){ return document.querySelectorAll('.stack-section').length; }
    function currentIndex(){ return Math.round(stackEl.scrollTop / getVH()); }

    function updateChrome(){
      const idx = currentIndex();

      // show/hide top nav + logo + rail (rail hidden on Hero)
      if (idx >= 1){
        globalNav.classList.add('is-visible');
        document.body.classList.add('logo-visible');
        railEl.classList.add('is-visible');
        railEl.classList.add('is-tucked');      // start tucked when visible
      } else {
        globalNav.classList.remove('is-visible');
        document.body.classList.remove('logo-visible');
        railEl.classList.remove('is-visible');
        railEl.classList.remove('is-tucked');   // reset when hidden
      }

      // If we are NOT on section 6, force S7 off so 'N' won't stay blue
      const TRUST_IDX = ID_TO_INDEX['trust'] ?? 5;
      if (idx !== TRUST_IDX && window.__elysianRail?.isS7){
        window.__elysianRail.isS7 = false;
      }

      // update active letter (respect S7 state)
      const id = (window.__elysianRail?.isS7) ? '@s7' : (INDEX_TO_ID[idx] || 'hero');
      window.__elysianRail?.setActiveByTarget(id);
      window.__elysianRail?.setIndex(idx);
    }
    stackEl.addEventListener('scroll', () => { requestAnimationFrame(updateChrome); }, {passive:true});
    window.addEventListener('resize', updateChrome, {passive:true});
    updateChrome();

    /* BG controller + final reveal */
    let finalTimer = null;
    (function(){
      const root = stackEl;
      if (!root) return;
      const bgObserver = new IntersectionObserver(function(entries){
        entries.forEach(function(entry){
          if (entry.isIntersecting) applyBG(entry.target);
          if (entry.target.id === 'sec-trust-2'){
            if (entry.isIntersecting){
              clearTimeout(finalTimer);
              finalTimer = setTimeout(function(){
                document.documentElement.classList.add('final-reveal');
              }, 4000);
            } else {
              clearTimeout(finalTimer);
              document.documentElement.classList.remove('final-reveal');
            }
          }
        });
      }, {root: root, threshold:0.6});

      document.querySelectorAll('.stack-section').forEach(function(s){ bgObserver.observe(s); });
    })();

    /* === Tell each iframe when its section is visibly on screen === */
    (function(){
      const root = document.getElementById('stackScroll');
      if (!root) return;

      const io = new IntersectionObserver((entries)=>{
        entries.forEach((entry)=>{
          const sec = entry.target;                // e.g., <section id="sec-trust-2">
          const id  = (sec.id || '').replace('sec-','');
          const frame = document.getElementById('frame-' + id);
          if (entry.isIntersecting && frame?.contentWindow){
            frame.contentWindow.postMessage({ type:'elysian:section-visible', id }, location.origin);
          }
        });
      }, { root, threshold: 0.6 });

      document.querySelectorAll('.stack-section').forEach(sec => io.observe(sec));
    })();

    /* Ensure autoplay */
    (function(){
      const v = document.getElementById('bg-video');
      if (!v) return;
      v.muted = true;
      const p = v.play && v.play();
      if (p && p.catch) p.catch(function(){});
    })();

    /* ======== LUXE PAGER: no mid-stops, one section per move ======== */
    (function(){
      const root = stackEl;
      if (!root) return;

      const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      let isAnimating = false;
      let animId = 0;
      let settleTimer = null;

      function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
      function indexToTop(i){ return i * getVH(); }

      // Custom tween for buttery feel
      function easeInOutCubic(t){ return t<0.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2,3)/2; }

      function animateToIndex(targetIdx, dur=640){
        const max = sectionCount()-1;
        targetIdx = clamp(targetIdx, 0, max);
        const startTop = root.scrollTop;
        const endTop = indexToTop(targetIdx);
        const delta = endTop - startTop;
        if (Math.abs(delta) < 1 || prefersReduced){
          root.scrollTop = endTop;
          isAnimating = false;
          return;
        }
        isAnimating = true;
        const id = ++animId;
        const t0 = performance.now();
        const D = dur;

        function step(now){
          if (id !== animId) return; // canceled
          const u = clamp((now - t0)/D, 0, 1);
          const eased = easeInOutCubic(u);
          root.scrollTop = startTop + delta * eased;
          if (u < 1){
            requestAnimationFrame(step);
          } else {
            isAnimating = false;
            root.scrollTop = endTop; // exact land
            if (typeof window.__elysianFreezeInput === 'function') window.__elysianFreezeInput(220);
          }
        }
        requestAnimationFrame(step);
      }

      function nearestIndex(){
        return clamp(Math.round(root.scrollTop / getVH()), 0, sectionCount()-1);
      }

      function go(delta){
        if (isAnimating) return;
        const now = (performance && performance.now) ? performance.now() : Date.now();
        if (now - lastMoveAt < MIN_GAP) return; // too soon after previous move
        lastMoveAt = now;
        animateToIndex(currentIndex() + delta);
      }

      // Wheel / trackpad: coalesce to one move
      let wheelAccum = 0, wheelTimer = null, lastMoveAt = 0; const MIN_GAP = 420; // ms between section moves
      // expose tiny helpers so parent can cancel any pending moves
      window.__elysianAbortWheel = function(){ wheelAccum = 0; clearTimeout(wheelTimer); };
      window.__elysianCancelSettle = function(){ clearTimeout(settleTimer); };

      root.addEventListener('wheel', (e)=>{
        e.preventDefault();
        if (isAnimating) return;
        if ((performance.now ? performance.now() : Date.now()) < (window.__elysianFreezeUntil || 0)){
          // swallow leftover momentum
          wheelAccum = 0; clearTimeout(wheelTimer);
          return;
        }
        wheelAccum += e.deltaY;
        clearTimeout(wheelTimer);
        wheelTimer = setTimeout(()=>{
          const THRESH = 160;
          const now = (performance && performance.now) ? performance.now() : Date.now();
          if (Math.abs(wheelAccum) > THRESH && (now - lastMoveAt) > MIN_GAP){
            lastMoveAt = now;
            go(wheelAccum > 0 ? +1 : -1);
          }
          wheelAccum = 0;
        }, 140);
      }, {passive:false});

      // Touch swipes
      let touchStartY = null, touchStartT = 0;
      root.addEventListener('touchstart', (e)=>{
        if (e.touches && e.touches.length === 1){
          touchStartY = e.touches[0].clientY;
          touchStartT = performance.now();
          // cancel any running tween so the user can take over
          animId++; isAnimating = false;
        }
      }, {passive:true});

      root.addEventListener('touchend', (e)=>{
        if ((performance.now ? performance.now() : Date.now()) < (window.__elysianFreezeUntil || 0)) return;
        if (touchStartY == null) return;
        const t = performance.now() - touchStartT;

        const endY = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0].clientY : touchStartY;
        const dy = endY - touchStartY; // + = swipe down
        touchStartY = null;

        if (Math.abs(dy) > 40 || t < 250){
          go(dy < 0 ? +1 : -1);
        } else {
          // small flick: settle to nearest
          animateToIndex(nearestIndex(), 520);
        }
      }, {passive:true});

      // Keyboard
      window.addEventListener('keydown', (e)=>{
        if (isAnimating) return;
        if ((performance.now ? performance.now() : Date.now()) < (window.__elysianFreezeUntil || 0)){
          e.preventDefault(); return;
        }
        const idx = currentIndex();

        if (e.key === 'ArrowDown' || e.key === 'PageDown' || (e.key === ' ' && !e.shiftKey)){
          e.preventDefault(); animateToIndex(idx + 1);
        } else if (e.key === 'ArrowUp' || e.key === 'PageUp' || (e.key === ' ' && e.shiftKey)){
          e.preventDefault(); animateToIndex(idx - 1);
        } else if (e.key === 'Home'){
          e.preventDefault(); animateToIndex(0);
        } else if (e.key === 'End'){
          e.preventDefault(); animateToIndex(sectionCount()-1);
        }
      });

      // Settle to nearest after manual scroll inertia stops
      root.addEventListener('scroll', ()=>{
        clearTimeout(settleTimer);
        if (isAnimating) return;
        settleTimer = setTimeout(()=>{
          if ((performance.now ? performance.now() : Date.now()) < (window.__elysianFreezeUntil || 0)) return;
          animateToIndex(nearestIndex(), 520);
        }, 120);
      }, {passive:true});

      // On resize, re-align to the exact pixel for current section
      window.addEventListener('resize', ()=>{
        const idx = nearestIndex();
        animId++; isAnimating = false;
        root.scrollTop = indexToTop(idx);
      }, {passive:true});

      /* === EXPOSE pager API to iframes === */
      window.ElysianPager = {
        goNext(){ animateToIndex(currentIndex()+1); },
        goPrev(){ animateToIndex(currentIndex()-1); },
        goToId(id){ const i = ID_TO_INDEX[id] ?? 0; animateToIndex(i); },
        currentId(){ return INDEX_TO_ID[currentIndex()]; }
      };
    })();
    /* ======== END LUXE PAGER ======== */

    /* === Parent message bridge: iframes -> pager === */
    window.addEventListener('message', (evt)=>{
      const okOrigin = (evt.origin === location.origin) || (evt.origin === 'null');
      if (!okOrigin) return;
      const { type, target } = evt.data || {};

      if (type === 'elysian:go-next'){
        __elysianFreezeInput(700);
        return window.ElysianPager?.goNext();
      }

      // Coming back from S7 → S6
      if (type === 'elysian:go-prev'){
        __elysianHardBrake(1400);
        window.__elysianRail && (window.__elysianRail.isS7 = false);
        window.__elysianRail?.setActiveByTarget('trust'); // A turns blue
        return window.ElysianPager?.goPrev();
      }

      if (type === 'elysian:sweep-to' && target){
        __elysianFreezeInput(700);
        return window.ElysianPager?.goToId(target);
      }

      // S7 opened inside section 6 → make N blue
      if (type === 'elysian:s7-opened'){
        if (window.__elysianRail){
          window.__elysianRail.isS7 = true;
          window.__elysianRail.setActiveByTarget('@s7'); // light N
        }
      }
    });

    /* Last-resort boot cover removal */
    setTimeout(function(){
      if (bootCover.getAttribute('aria-hidden') !== 'true'){
        bootCover.classList.add('is-gone');
        setTimeout(()=>bootCover.setAttribute('aria-hidden','true'), 500);
      }
    }, 1500);

    /* === Clickable Logo -> jump to the first section (Hero) === */
    (function(){
      const logo = document.getElementById('ElysianDockLogo');
      if (!logo) return;

      function goHome(){
        window.ElysianPager?.goToId('hero');
      }

      logo.addEventListener('click', goHome);
      logo.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); goHome(); }
      });
    })();

    //* === Nav buttons (robust CONNECT) === */
    (function(){
      const nav = document.getElementById('globalHeroNav');
      if (!nav) return;

      const WRITINGS_URL    = '/writings/';
      const INSTRUMENTS_URL = '/instruments/';

      nav.addEventListener('click', (e)=>{
        const btn = e.target.closest('.nav-btn');
        if (!btn) return;

        const target = btn.dataset.target;

        if (target === 'writings'){    window.location.href = WRITINGS_URL;    return; }
        if (target === 'instruments'){ window.location.href = INSTRUMENTS_URL; return; }

        if (target === 'connect'){
          // 1) Page to Section 6 (the TRUST iframe that holds S6+S7)
          __elysianHardBrake(1400);
          window.ElysianPager?.goToId('trust');

          // 2) Repeatedly nudge the iframe to open S7 until it ACKs
          const frame = document.getElementById('frame-trust');
          if (!frame) return;

          const targetOrigin = (location.origin && location.origin !== 'null') ? location.origin : '*';
          let tries = 0, timer = null, max = 25; // ~25*120ms ≈ 3 seconds

          function sendNudge(){
            tries++;
            try{
              frame.contentWindow?.postMessage(
                { type:'elysian:focus-anchor', target:'connect' },
                targetOrigin
              );
            }catch(_){}
            if (tries >= max){ clearInterval(timer); }
          }

          // Stop on ACK from the iframe
          function onAck(evt){
            const ok = (evt.origin === location.origin) || (evt.origin === 'null');
            if (!ok) return;
            if (evt.data && evt.data.type === 'elysian:s7-opened'){
              clearInterval(timer);
              window.removeEventListener('message', onAck);
            }
          }

          window.addEventListener('message', onAck);
          // Kick once immediately, then keep nudging until ACK
          sendNudge();
          timer = setInterval(sendNudge, 240);
        }
      });
    })();

    /* ===== INLINE-CTA WIRES from S6 (index-only) ===== */
    (function(){
      const WRITINGS_URL    = '/writings/';
      const INSTRUMENTS_URL = '/instruments/';

      const frame = document.getElementById('frame-trust');
      if (!frame) return;

      function wireInlineCtas(){
        try{
          const doc = frame.contentDocument;
          if (!doc) return;
          doc.addEventListener('click', function(e){
            const a = e.target.closest('a.inline-cta[href]');
            if (!a) return;
            if (e.metaKey || e.ctrlKey || e.shiftKey || e.button === 1) return;

            const href = a.getAttribute('href') || '';
            if (href.includes('writings')){
              e.preventDefault(); window.location.href = WRITINGS_URL; return;
            }
            if (href.includes('instruments')){
              e.preventDefault(); window.location.href = INSTRUMENTS_URL; return;
            }
          }, true);
        }catch(_){}
      }

      frame.addEventListener('load', wireInlineCtas);
    })();

    /* ===== WATCH S7 STATE INSIDE THE IFRAME (robust A/N highlight) ===== */
    (function(){
      const TRUST_ID = 'trust';
      const TRUST_IDX = () => (ID_TO_INDEX[TRUST_ID] ?? 5);

      function mountS7Watcher(){
        const frame = document.getElementById('frame-trust');
        if (!frame) return;
        try{
          const doc = frame.contentDocument;
          if (!doc) return;
          const html = doc.documentElement;

          // Update rail whenever S7 mode toggles inside the iframe
          const update = ()=>{
            const on = html.classList.contains('phase-s7');
            const idx = currentIndex();
            if (idx === TRUST_IDX()){
              window.__elysianRail.isS7 = !!on;
              window.__elysianRail.setActiveByTarget(on ? '@s7' : 'trust');
            } else {
              // If we're not on section 6, don't keep 'N' blue
              window.__elysianRail.isS7 = false;
              window.__elysianRail.setActiveByTarget(INDEX_TO_ID[idx] || 'hero');
            }
          };

          update();
          // Observe class changes on <html> inside the iframe
          const mo = new MutationObserver(update);
          mo.observe(html, { attributes:true, attributeFilter:['class'] });

          // Keep a reference to disconnect later if needed
          frame._s7mo && frame._s7mo.disconnect();
          frame._s7mo = mo;
        }catch(_){}
      }

      // Install watcher after the trust frame loads (and also if already loaded)
      const f = document.getElementById('frame-trust');
      if (f){
        if (f.contentDocument && f.contentDocument.readyState === 'complete'){
          mountS7Watcher();
        }
        f.addEventListener('load', mountS7Watcher);
      }
    })();

    /* ===== ELYSIAN ⇄ CLARITY RAIL logic ===== */
    (function(){
      const rail  = document.getElementById('elysian-rail');
      const btns  = Array.from(rail.querySelectorAll('.letter'));

      const ORDER = ['hero','for','action','truth','work','trust','@s7'];
      const WORDS = ['ELYSIAN','CLARITY'];
      let wordIx = 0;
      let lastIndex = 0;
      let lastDir = null;

      function setLetters(word){
        btns.forEach((b,i)=>{
          b.style.transform = 'scale(0.92)';
          b.textContent = word[i];
          requestAnimationFrame(()=> b.style.transform = 'scale(1)');
        });
      }
      function toggleWord(){ wordIx = 1 - wordIx; setLetters(WORDS[wordIx]); }

      function updateIndicatorByBtn(btn){
        if (!btn) return;
        const railRect = rail.getBoundingClientRect();
        const r = btn.getBoundingClientRect();
        const center = (r.top + r.height/2) - railRect.top;
        rail.style.setProperty('--indY', center + 'px');
      }

      function setActiveByTarget(t){
        btns.forEach(b=> b.setAttribute('aria-selected', (b.dataset.target===t) ? 'true':'false'));
        updateIndicatorByBtn(btns.find(b=> b.dataset.target===t));
      }

      function setIndex(newIdx){
        const dir = newIdx > lastIndex ? 'down' : (newIdx < lastIndex ? 'up' : lastDir);
        if (dir && lastDir && dir !== lastDir) toggleWord();
        if (dir) lastDir = dir;
        lastIndex = newIdx;
      }

      function goToTarget(target){
        if (target === 'trust'){
          // Explicitly leave S7 and show section 6 (A turns blue)
          window.__elysianRail.isS7 = false;
          setActiveByTarget('trust');
          setIndex(ORDER.indexOf('trust'));
          window.ElysianPager?.goToId('trust');

          // Ask the iframe politely to close S7 if it was open (smooth return)
          const frame = document.getElementById('frame-trust');
          try{
            const doc = frame?.contentDocument;
            if (doc){
              // 1) remove the global S7 class
              doc.documentElement.classList.remove('phase-s7');
              // 2) trigger its internal "return to S6" animation hook
              const CE = doc.defaultView?.CustomEvent || CustomEvent;
              doc.dispatchEvent(new CE('sectionchange', { detail: { id:'s6', from:'parent' } }));
            }
          }catch(_){}
          return;
        }

        if (target === '@s7'){
          // open S7 from the rail
          __elysianHardBrake(1400);
          window.ElysianPager?.goToId('trust');

          const frame = document.getElementById('frame-trust');
          if (frame){
            const targetOrigin = (location.origin && location.origin !== 'null') ? location.origin : '*';
            let tries = 0, timer = null, max = 25;
            function sendNudge(){
              tries++;
              try{ frame.contentWindow?.postMessage({ type:'elysian:focus-anchor', target:'connect' }, targetOrigin); }catch(_){}
              if (tries >= max) clearInterval(timer);
            }
            function onAck(evt){
              const ok = (evt.origin === location.origin) || (evt.origin === 'null');
              if (!ok) return;
              if (evt.data && evt.data.type === 'elysian:s7-opened'){
                clearInterval(timer);
                window.removeEventListener('message', onAck);
              }
            }
            window.addEventListener('message', onAck);
            sendNudge();
            timer = setInterval(sendNudge, 240);
          }
          window.__elysianRail.isS7 = true;
          setActiveByTarget('@s7');
          setIndex(6);
          return;
        }

        const idx = ORDER.indexOf(target);
        if (idx !== -1) setIndex(idx);
        window.ElysianPager?.goToId(target);
        setActiveByTarget(target);
      }

      btns.forEach(btn=> btn.addEventListener('click', ()=> goToTarget(btn.dataset.target)));

      // expose a tiny API so index.js can coordinate easily
      window.__elysianRail = {
        isS7: false,
        setActiveByTarget,
        setIndex
      };

      // init letters (ELYSIAN), no active by default (Hero hides the rail)
      setLetters(WORDS[0]);

      // keep dot centered after resize (when visible)
      window.addEventListener('resize', ()=>{
        const sel = btns.find(b => b.getAttribute('aria-selected') === 'true');
        if (sel) updateIndicatorByBtn(sel);
      }, {passive:true});

      /* --- Proximity reveal & re-tuck --- */
      (function(){
        if (!rail) return;

        const EDGE_ZONE_MOUSE = 120; // px from right edge to start revealing
        const EDGE_ZONE_TOUCH = 84;  // smaller zone for touch
        let retuckTO = null;

        const tuck = (on) => rail.classList.toggle('is-tucked', !!on);
        const nearEdge = (x, zone) => (window.innerWidth - x) <= zone;

        // Reveal when mouse moves near the right edge; tuck when away (unless hovering/focused)
        window.addEventListener('mousemove', (e)=>{
          if (!rail.classList.contains('is-visible')) return;
          const near = nearEdge(e.clientX, EDGE_ZONE_MOUSE);
          if (near) {
            tuck(false);
          } else if (!rail.matches(':hover, :focus-within')) {
            tuck(true);
          }
        }, {passive:true});

        // Classic hover/focus behavior
        rail.addEventListener('mouseenter', ()=> tuck(false));
        rail.addEventListener('mouseleave', ()=> tuck(true));
        rail.addEventListener('focusin',   ()=> tuck(false));
        rail.addEventListener('focusout',  ()=>{
          clearTimeout(retuckTO);
          retuckTO = setTimeout(()=> tuck(true), 700);
        });

        // Touch: tap near the edge to reveal briefly
        window.addEventListener('touchstart', (e)=>{
          const t = e.changedTouches && e.changedTouches[0];
          if (!t || !rail.classList.contains('is-visible')) return;
          if (nearEdge(t.clientX, EDGE_ZONE_TOUCH)){
            tuck(false);
            clearTimeout(retuckTO);
            retuckTO = setTimeout(()=> tuck(true), 2500); // auto re-tuck after a short while
          }
        }, {passive:true});
      })();
    })();
  </script>

  <noscript>
    <style>html{background:#000}</style>
  </noscript>
</body>
</html>








